{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://learninghub.local/schemas/lesson_blueprint.schema.json",
  "title": "Universal Lesson Blueprint (RO, middle school ICT/CS)",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "meta",
    "why_this_matters",
    "competency_contract",
    "knowledge_progression",
    "instructional_flow",
    "assessment",
    "spaced_retrieval_plan",
    "teacher_notes"
  ],
  "properties": {
    "meta": { "$ref": "#/$defs/meta" },
    "why_this_matters": { "$ref": "#/$defs/why" },
    "competency_contract": { "$ref": "#/$defs/competencyContract" },
    "knowledge_progression": { "$ref": "#/$defs/progression" },
    "instructional_flow": { "$ref": "#/$defs/flow" },
    "assessment": { "$ref": "#/$defs/assessment" },
    "spaced_retrieval_plan": { "$ref": "#/$defs/spaced" },
    "teacher_notes": { "$ref": "#/$defs/teacherNotes" },

    "x_metadata": { "type": "object" }
  },
  "$defs": {
    "grade": { "type": "string", "enum": ["V", "VI", "VII", "VIII"] },

    "competencyRef": {
      "type": "object",
      "additionalProperties": false,
      "required": ["id", "text_ro"],
      "properties": {
        "id": { "type": "string", "minLength": 1 },
        "text_ro": { "type": "string", "minLength": 1 }
      }
    },

    "meta": {
      "type": "object",
      "additionalProperties": false,
      "required": ["grade", "module_index", "lesson_code", "title_ro", "duration_minutes", "prerequisites", "tools", "safety_and_ethics"],
      "properties": {
        "grade": { "$ref": "#/$defs/grade" },
        "module_index": { "type": "integer", "minimum": 1, "maximum": 5 },
        "lesson_code": { "type": "string", "pattern": "^[A-ZIV]{1,4}-M[1-5]-L\\d{2}$" },
        "title_ro": { "type": "string", "minLength": 1 },
        "duration_minutes": { "type": "integer", "minimum": 30, "maximum": 120 },
        "prerequisites": { "type": "array", "items": { "type": "string" } },
        "tools": { "type": "array", "items": { "type": "string" } },
        "safety_and_ethics": { "type": "array", "items": { "type": "string" } }
      }
    },

    "why": {
      "type": "object",
      "additionalProperties": false,
      "required": ["purpose_ro", "real_life_scenarios"],
      "properties": {
        "purpose_ro": { "type": "string", "minLength": 10 },
        "real_life_scenarios": { "type": "array", "minItems": 1, "items": { "type": "string", "minLength": 5 } }
      }
    },

    "levels3": {
      "type": "object",
      "additionalProperties": false,
      "required": ["minim", "standard", "performanta"],
      "properties": {
        "minim": { "type": "array", "minItems": 1, "items": { "type": "string" } },
        "standard": { "type": "array", "minItems": 1, "items": { "type": "string" } },
        "performanta": { "type": "array", "minItems": 1, "items": { "type": "string" } }
      }
    },

    "competencyContract": {
      "type": "object",
      "additionalProperties": false,
      "required": ["official_specific_competencies", "i_can_statements"],
      "properties": {
        "official_specific_competencies": {
          "type": "array",
          "minItems": 1,
          "items": { "$ref": "#/$defs/competencyRef" }
        },
        "i_can_statements": { "$ref": "#/$defs/levels3" }
      }
    },

    "conceptLevel": {
      "type": "object",
      "additionalProperties": false,
      "required": ["level", "concepts"],
      "properties": {
        "level": { "type": "string", "enum": ["general", "intermediate", "specific"] },
        "concepts": { "type": "array", "minItems": 1, "items": { "type": "string" } }
      }
    },

    "misconception": {
      "type": "object",
      "additionalProperties": false,
      "required": ["misconception", "fix_strategy"],
      "properties": {
        "misconception": { "type": "string", "minLength": 5 },
        "fix_strategy": { "type": "string", "minLength": 5 }
      }
    },

    "progression": {
      "type": "object",
      "additionalProperties": false,
      "required": ["from_general_to_specific", "common_misconceptions"],
      "properties": {
        "from_general_to_specific": { "type": "array", "minItems": 3, "maxItems": 3, "items": { "$ref": "#/$defs/conceptLevel" } },
        "common_misconceptions": { "type": "array", "items": { "$ref": "#/$defs/misconception" } }
      }
    },

    "workedExample": {
      "type": "object",
      "additionalProperties": false,
      "required": ["example_title", "steps", "teacher_thinks_aloud"],
      "properties": {
        "example_title": { "type": "string", "minLength": 1 },
        "steps": { "type": "array", "minItems": 1, "items": { "type": "string" } },
        "teacher_thinks_aloud": { "type": "array", "minItems": 1, "items": { "type": "string" } }
      }
    },

    "guidedTask": {
      "type": "object",
      "additionalProperties": false,
      "required": ["task", "scaffold", "success_criteria"],
      "properties": {
        "task": { "type": "string", "minLength": 5 },
        "scaffold": { "type": "array", "items": { "type": "string" } },
        "success_criteria": { "type": "array", "minItems": 1, "items": { "type": "string" } }
      }
    },

    "practiceTask": {
      "type": "object",
      "additionalProperties": false,
      "required": ["task", "expected_output"],
      "properties": {
        "task": { "type": "string", "minLength": 5 },
        "expected_output": { "type": "string", "minLength": 3 }
      }
    },

    "microLecture": {
      "type": "object",
      "additionalProperties": false,
      "required": ["key_terms", "explain_like_im_12", "rules_and_checks"],
      "properties": {
        "key_terms": { "type": "array", "minItems": 3, "items": { "type": "string" } },
        "explain_like_im_12": { "type": "string", "minLength": 10 },
        "rules_and_checks": { "type": "array", "minItems": 2, "items": { "type": "string" } }
      }
    },

    "exitTicket": {
      "type": "object",
      "additionalProperties": false,
      "required": ["minim", "standard", "performanta"],
      "properties": {
        "minim": { "type": "array", "minItems": 1, "items": { "type": "string" } },
        "standard": { "type": "array", "minItems": 1, "items": { "type": "string" } },
        "performanta": { "type": "array", "minItems": 1, "items": { "type": "string" } }
      }
    },

    "independentPractice": {
      "type": "object",
      "additionalProperties": false,
      "required": ["minim", "standard", "performanta"],
      "properties": {
        "minim": { "type": "array", "minItems": 1, "items": { "$ref": "#/$defs/practiceTask" } },
        "standard": { "type": "array", "minItems": 1, "items": { "$ref": "#/$defs/practiceTask" } },
        "performanta": { "type": "array", "minItems": 1, "items": { "$ref": "#/$defs/practiceTask" } }
      }
    },

    "flow": {
      "type": "object",
      "additionalProperties": false,
      "required": ["hook_3min", "micro_lecture_8_10min", "worked_examples_10min", "guided_practice_12min", "independent_practice_12min", "exit_ticket_3min"],
      "properties": {
        "hook_3min": { "type": "string", "minLength": 5 },
        "micro_lecture_8_10min": { "$ref": "#/$defs/microLecture" },
        "worked_examples_10min": { "type": "array", "minItems": 1, "items": { "$ref": "#/$defs/workedExample" } },
        "guided_practice_12min": { "type": "array", "minItems": 1, "items": { "$ref": "#/$defs/guidedTask" } },
        "independent_practice_12min": { "$ref": "#/$defs/independentPractice" },
        "exit_ticket_3min": { "$ref": "#/$defs/exitTicket" }
      }
    },

    "quizItem": {
      "type": "object",
      "additionalProperties": false,
      "required": ["type", "prompt", "answer_key"],
      "properties": {
        "type": { "type": "string", "enum": ["mcq", "short", "ordering", "scenario", "debug"] },
        "prompt": { "type": "string", "minLength": 5 },
        "answer_key": { "type": "string", "minLength": 1 },
        "options": { "type": "array", "items": { "type": "string" } },
        "explanation": { "type": "string" }
      }
    },

    "quickQuiz": {
      "type": "object",
      "additionalProperties": false,
      "required": ["items_minim", "items_standard", "items_performanta"],
      "properties": {
        "items_minim": { "type": "array", "minItems": 1, "items": { "$ref": "#/$defs/quizItem" } },
        "items_standard": { "type": "array", "minItems": 1, "items": { "$ref": "#/$defs/quizItem" } },
        "items_performanta": { "type": "array", "minItems": 1, "items": { "$ref": "#/$defs/quizItem" } }
      }
    },

    "assessment": {
      "type": "object",
      "additionalProperties": false,
      "required": ["quick_quiz", "homework_optional"],
      "properties": {
        "quick_quiz": { "$ref": "#/$defs/quickQuiz" },
        "homework_optional": { "$ref": "#/$defs/levels3" }
      }
    },

    "spaced": {
      "type": "object",
      "additionalProperties": false,
      "required": ["R0_end_of_lesson", "R1_next_week", "R2_after_3_weeks"],
      "properties": {
        "R0_end_of_lesson": { "type": "array", "minItems": 1, "items": { "type": "string" } },
        "R1_next_week": { "type": "array", "minItems": 1, "items": { "type": "string" } },
        "R2_after_3_weeks": { "type": "array", "minItems": 1, "items": { "type": "string" } }
      }
    },

    "timebox": {
      "type": "object",
      "additionalProperties": false,
      "required": ["segment", "minutes"],
      "properties": {
        "segment": { "type": "string", "minLength": 1 },
        "minutes": { "type": "integer", "minimum": 0, "maximum": 120 }
      }
    },

    "teacherNotes": {
      "type": "object",
      "additionalProperties": false,
      "required": ["differentiation", "timeboxing"],
      "properties": {
        "differentiation": {
          "type": "object",
          "additionalProperties": false,
          "required": ["support", "stretch"],
          "properties": {
            "support": { "type": "array", "items": { "type": "string" } },
            "stretch": { "type": "array", "items": { "type": "string" } }
          }
        },
        "timeboxing": { "type": "array", "minItems": 3, "items": { "$ref": "#/$defs/timebox" } }
      }
    }
  }
}
